app-id: io.github.ja2_stracciatella.JA2-Stracciatella
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - "org.freedesktop.Sdk.Extension.rust-stable"
command: ja2-launcher-wrapper
rename-desktop-file: ja2-stracciatella.desktop
rename-icon: ja2-stracciatella
finish-args:
  - "--share=network"
  - "--socket=fallback-x11"
  - "--socket=wayland"
  - "--share=ipc"
  - "--device=dri"
  - "--socket=pulseaudio"
  - "--env=SDL_VIDEODRIVER=wayland,x11"
  # Persist ja2 setting files
  - "--persist=.ja2"
  # And allow some filesystem access to let JA2 read the game files
  - "--filesystem=xdg-documents"
modules:
  - name: string_theory
    buildsystem: cmake-ninja
    config-opts:
      - "-DST_BUILD_TESTS=OFF"
      - "-Wno-dev"
    sources:
      - type: git
        url: https://github.com/zrax/string_theory.git
        tag: "3.9"
        commit: "42e68a9709936ab379eac4dd6ba53deb2b322e03"
    cleanup: ["*"] # header-only library, we need not retain anything
  - shared-modules/lua5.3/lua-5.3.5.json
  - name: sol2
    buildsystem: cmake-ninja
    config-opts:
      - "-DSOL2_LUA_VERSION=5.3"
      - "-DSOL2_BUILD_LUA=OFF"
      - "-DSOL2_TESTS_SINGLE=OFF"
      - "-DSOL2_TESTS_EXAMPLES=OFF"
      - "-Wno-dev"
    sources:
      - type: git
        url: "https://github.com/ThePhD/sol2.git"
        tag: v3.5.0
        commit: "9190880c593dfb018ccf5cc9729ab87739709862"
    cleanup: ["*"] # header-only library, we need not retain anything
  # FLTK needs glu for its wayland backend
  - shared-modules/glu/glu-9.json
  - name: fltk
    buildsystem: cmake-ninja
    config-opts:
      - "-DFLTK_USE_WAYLAND=ON" # Make sure we get wayland support
      - "-DFLTK_BUILD_FLUID=ON" # JA2 needs fluid to find Fltk
      - "-DFLTK_BUILD_SHARED_LIBS=ON"
      - "-DFLTK_BUILD_HTML_DOCS=OFF"
      - "-DFLTK_BUILD_PDF_DOCS=OFF"
      - "-DFLTK_BUILD_TEST=OFF"
      - "-DFLTK_BUILD_EXAMPLES=OFF"
      - "-DFLTK_BUILD_FLTK_OPTIONS=OFF"
      - "-Wno-dev"
    sources:
      - type: git
        url: https://github.com/fltk/fltk.git
        tag: "release-1.4.4"
        commit: "9c70ea95a176933ffd575022d145c284d1fc9ef7"
    cleanup:
      - /bin/
      - /include
      - /man
      - /share/doc
      - /share/man
      - /share/applications
      - /share/icons
      - /share/mime
      - /share/fltk
      - /lib/pkgconfig
      - /lib/*.a
  - name: ja2-stracciatella
    buildsystem: cmake-ninja
    build-options:
      env:
        # Point cargo to crates downloaded by flatpak from cargo-sources.json
        CARGO_HOME: "/run/build/ja2-stracciatella/cargo"
      # Add cargo to $PATH while building this module
      append-path: "/usr/lib/sdk/rust-stable/bin"
    config-opts:
      - "-DEXTRA_DATA_DIR=/app/share/ja2"
      - "-DLOCAL_LUA_LIB=OFF"
      - "-DLOCAL_SOL_LIB=OFF"
      - "-DLOCAL_STRING_THEORY_LIB=OFF"
      - "-DLOCAL_MINIAUDIO_LIB=OFF"
      - "-DMINIAUDIO_INCLUDE_DIR=/run/build/ja2-stracciatella/dependencies/lib-miniaudio/src"
      - "-DLOCAL_MAGICENUM_LIB=OFF"
      - "-DMAGICENUM_INCLUDE_DIR=/run/build/ja2-stracciatella/dependencies/lib-magic_enum/src"
      - "-DWITH_UNITTESTS=OFF"
      - "-Wno-dev"
    post-install:
      - install -Dm755 ja2-launcher-wrapper /app/bin/ja2-launcher-wrapper
      - install -Dm644 io.github.ja2_stracciatella.JA2-Stracciatella.appdata.xml "${FLATPAK_DEST}/share/metainfo/io.github.ja2_stracciatella.JA2-Stracciatella.metainfo.xml"
    sources:
      - type: git
        url: https://github.com/ja2-stracciatella/ja2-stracciatella.git
        tag: "v0.22.0"
        commit: "b195e15ab9f1f5c8bc17d1e86965d2f66b6ecbb3"
      # Cargo sources, generated with
      #
      #   flatpak run --command=flatpak-cargo-generator org.flatpak.Builder ${JA2_CLONE}/rust/Cargo.lock -o cargo-sources.json
      #
      # See https://github.com/flatpak/flatpak-builder-tools/tree/master/cargo
      # for details.
      - cargo-sources.json
      # Directly download required header-only or direct-include libraries.
      # Use exactly the same versions as used by JA2 upstream, in the CMake
      # getters.
      - type: git
        url: "https://github.com/mackron/miniaudio.git"
        commit: "4dfe7c4c31df46e78d9a1cc0d2d6f1aef5a5d58c"
        dest: "dependencies/lib-miniaudio/src"
      - type: file
        url: https://github.com/Neargye/magic_enum/releases/download/v0.8.2/magic_enum.hpp
        sha256: "f34487663db05b10acae7077dd0b5cf5794112a379567322e251ef0068875dc4"
        dest: "dependencies/lib-magic_enum/src"
      # Upstream metadata.
      #
      # TODO: Attempt to upstream this
      - type: file
        path: io.github.ja2_stracciatella.JA2-Stracciatella.appdata.xml
      # Add a separate launcher to override TMPDIR, per documentation at
      # https://docs.flatpak.org/en/latest/sandbox-permissions.html#filesystem-access
      # The launcher uses TMPDIR to store its own log files and to read game log
      # files.
      - type: script
        dest-filename: ja2-launcher-wrapper
        commands:
          - 'export TMPDIR="${XDG_RUNTIME_DIR}/app/${FLATPAK_ID}"'
          - 'exec /app/bin/ja2-launcher "$@"'
    cleanup:
      - /share/ja2/unittests
      - /share/man
